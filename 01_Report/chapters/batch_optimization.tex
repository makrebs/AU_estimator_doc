\chapter{Batch Optimization}
\label{chap:batch}

Figure \ref{fig:batch_opti} gives an overview on how the batch optimization problem is solved.
On one hand, the real system is fed with some specific inputs and the system behaviour is measured by the IMU.
On the other hand, virtual IMU measurements are calculated for the same inputs using a parameterized system model.
The goal of the batch optimization is to find those parameters of the system model, that minimize the difference between the real and virtual system output.
In the following, the relevant parts of the batch optimization is explained in detail.

\begin{figure}[hbtp]
\label{fig:batch_opti}
\centering
\includegraphics[width=0.85\textwidth]{images/dummy.png}
\caption{Scheme for optimization of parameterized system model.}
\end{figure}

\section{System Model}
\label{sec:system_model}
A system model for Skye has been stated by Weichart in \cite{Weichart2012} and is summarized in table \ref{tab:sys_mod}.

\begin{table}[htb!]
\centering
\label{tab:sys_mod}
$\begin{array}{ll}
\toprule
\dot{\boldsymbol{\omega}}_b^b &= \mathbf{J}_b^{-1} \left( \mathbf{M}_b  - \boldsymbol{\omega}_b^b \times \mathbf{J}_b \boldsymbol{\omega}_b^b \right) \\

\dot{\mathbf{q}}_w^{b,w} &= \frac{1}{2} \mathbf{q}_w^{b,w} \otimes \left[
\begin{array}{c}
	0 \\ \boldsymbol{\omega}_b^b
\end{array} \right] \\

\dot{\mathbf{v}}_b^b &= \mathbf{\mathcal{M}}_b^{-1} \mathbf{F}_b \\

\dot{\mathbf{p}}_w^{b,w} &= \mathbf{v}_w^b \\

\bottomrule
\end{array}$
\caption{Equations of motion for Skye}
\end{table}

It consists on the differential equations for the angular velocity $\boldsymbol{\omega}$, orientation quaternion $\mathbf{q}$, velocity $\mathbf{v}$, and position $\mathbf{p}$.
Skye is assumed as one rigid body.
Active forces and moments with respect to its center of gravity are concentrated as $\mathbf{F}$ and $\mathbf{M}$ respectively.
The total mass $\mathbf{\mathcal{M}}$ includes the rigid mass, helium mass as well as the virtual mass compensating for the inertia of the surrounding fluid.
The moment of inertia (or inertia tensor) $\mathbf{J}$ does not contain a virtual part as we focus on sphere like blimps.
\\
For the batch optimization, we content ourself with the angular acceleration $\boldsymbol{\alpha}$ as outlined in chapter \ref{chap:design_evaluation} and will have a closer look to the corresponding equation now.

\begin{equation}
\label{eq:angular_accel}
\boldsymbol{\alpha}_b^b = \mathbf{J}_b^{-1} \left( \mathbf{M}_b  - \boldsymbol{\omega}_b^b \times \mathbf{J}_b \boldsymbol{\omega}_b^b \right)
\end{equation}

The change of angular velocity is given by the active moments $\mathbf{M}$ as well as the nutation term $\boldsymbol{\omega} \times \mathbf{J} \boldsymbol{\omega}$.
\\
The latter term influences the rotation axis such that the free body will asymptotically end in a rotation around its smallest or or largest principle inertia axis.
For a homogeneous sphere, the inertia tensor is diagonal with all its diagonal elements equal and the cross product in \eqref{eq:angular_accel} is therefore zero (because $\boldsymbol{\omega}$ and $\mathbf{J}\boldsymbol{\omega}$ are parallel).
As Skye itself is not as perfect symmetric than a sphere (compare section \ref{sub:par_inertia}) the nutation term will be considered although it is much smaller than the active moment.
\\
As shown in \eqref{eq:moments}, the active moment consists of an actuation term $\mathbf{M}^{actuation}$, a gravitation term $\mathbf{M}^{gravitation}$, and an aerodynamic term $\mathbf{M}^{aero}$.

\begin{equation}
\label{eq:moments}
\mathbf{M}_b = \underbrace{\sum_{k=1}^N  \left[  \mathbf{C}_{b,m_k} \left( \mathbf{p}^{m_k,cog}_{m_k} \times \mathbf{F}_{m_k} \right)  \right]}_{\mathbf{M}^{actuation}}
-
\underbrace{
 \left( \mathbf{p}^{cob,cog}_b \times (\mathbf{C}_{b,w}m\mathbf{g}_w) \right)
}_{\mathbf{M}^{gravity}}
-
\underbrace{
c_D^{rot} \rho_{air} \frac{\boldsymbol{\omega}}{\|\boldsymbol{\omega}\|} \|\boldsymbol{\omega}\|^2
}_{\mathbf{M}^{aero}}
\end{equation}

For the actuation term, the moment is first calculated in the separate motor coordinate frames $m_k$ and then transformed by the rotation matrix $C_{b,m_k}$ to blimp coordinates $b$.
The position vector $\mathbf{p}^{m_k,cog}_{m_k}$ is expressed in motor coordinates too.
As discussed in section \ref{sub:par_position}, this simplifies the equation a lot, if one assumes the motors to be placed on a sphere. The motors forces $\mathbf{F}_{m_k}$  


\begin{figure}[hbtp]
\label{fig:frames}
\centering
\includegraphics[width=.4\linewidth]{images/motor_frame.png}
\includegraphics[width=.4\linewidth]{images/blimp_frame.png}
\caption{\textbf{Left}: Motor coordinate frame $b$. When the thruster is not rotated, it directs in $\mathbf{e}^x_{m_k}$ direction. $\mathbf{e}^z_{m_k}$ directs to the bottom. \textbf{Right}: Blimp coordinate frame $m_k$. $\mathbf{e}^x_{b}$ directs to the camera which is mounted at the front. $\mathbf{e}^x_{b}$ directs to the bottom.}
\end{figure}

\section{Parameterization}
As introduced in section \ref{}... we want ... and we must ... because they are unsure/hard to measure
\subsection{Observability}
\label{sub:observability}
... tell what is (is not) observable. \\ Maybe also show why. \\ Cite \cite{hermann1977}

\subsection{Orientation}
\label{sub:par_orientation}
... Special Orthogonal Group
... Rodriquez-Gibbs parameters

\subsection{Position}
\label{sub:par_position}

\subsection{Inertia Tensor}
\label{sub:par_inertia}

\section{Minimization Problem}
... Formulate minimization problem (unconstraint) as least-squares.

\section{Nonlinear Least Squares}
... Cite \cite{Seber} (Nonlinear Regression) and maybe also \cite{Draper} (Applied Regression Analysis)

\section{Levenberg-Marquardt Algorithm}
... Again cite \cite{Seber} or directly Levenberg or Marquardt

\section{Jacobians / Derivatives}
... show how equations can be differentiated (for later use in LMA)

\section{Confidence Region}
... of parameters
... error propagation \cite{Siegwart}
